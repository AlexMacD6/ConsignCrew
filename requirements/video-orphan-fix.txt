# Video Orphan Fix

## Problem
Videos were becoming "orphaned" - uploaded and processed but not associated with any listing. This caused videos to disappear from the edit page and not show up on public listings.

## Root Causes Identified

### 1. No Listing Context During Upload
- VideoUpload component didn't receive listingId parameter
- Videos were created without knowing which listing they belonged to
- Association only happened when listing form was saved (deferred association)

### 2. Deferred Association Design Flaw
- System relied on users saving the listing form after video upload
- If users navigated away, refreshed, or encountered errors, association never happened
- Created orphaned videos that existed but weren't connected to listings

### 3. Authentication Issues in Testing
- Presigned URL endpoint had auth bypassed for testing
- Used first user in database instead of actual authenticated user
- Could cause videos to be created under wrong user account

### 4. Inconsistent Upload Endpoints
- Single video: `/api/upload/video/presigned-url` (no listing context)
- Bulk video: `/api/upload/video/bulk-presigned` (had listingId but didn't use for association)
- Different behaviors between upload methods

## Solution Implemented

### 1. Immediate Video-Listing Association
**Files Modified:**
- `app/components/VideoUpload.tsx`
- `app/api/upload/video/presigned-url/route.ts`
- `app/(dashboard)/list-item/[id]/edit/page.tsx`
- `app/(dashboard)/list-item/page.tsx`

**Changes:**
- Added `listingId` parameter to VideoUpload component
- Pass listingId from edit page to VideoUpload component
- Modified presigned URL API to accept listingId
- Immediately associate video with listing when listingId is provided
- Validate user owns the listing before association

### 2. Restored Proper Authentication
**File:** `app/api/upload/video/presigned-url/route.ts`

**Changes:**
- Removed auth bypass used for testing
- Restored proper user authentication
- Use authenticated user ID for video creation
- Validate listing ownership before association

### 3. Orphaned Video Recovery System
**File:** `app/api/admin/associate-orphaned-videos/route.ts` (new)

**Features:**
- GET endpoint to find orphaned videos for a user
- POST endpoint to manually associate videos with listings
- Security: Users can only access/associate their own videos
- Prevents duplicate associations

## How It Works Now

### For Edit Page (Existing Listings)
1. User uploads video on edit page
2. VideoUpload component receives listingId parameter
3. Video is immediately associated with listing during upload
4. Video appears in Product Videos section immediately
5. No need to save listing form for association

### For Create Page (New Listings)
1. User uploads video during listing creation
2. Video is created without listing association (listingId is undefined)
3. Video gets associated when listing is saved (existing behavior preserved)
4. Maintains backward compatibility

### Orphaned Video Recovery
1. API endpoint to find orphaned videos: `GET /api/admin/associate-orphaned-videos?listingId=KOPSI5`
2. API endpoint to associate video: `POST /api/admin/associate-orphaned-videos`
3. Can be used to fix existing orphaned videos

## Benefits

### Immediate Association
- ✅ Videos appear in edit page immediately after upload
- ✅ No more orphaned videos from edit page uploads
- ✅ Users don't need to remember to save listing form

### Security Improvements
- ✅ Proper authentication restored
- ✅ Listing ownership validation
- ✅ User can only associate their own videos

### Backward Compatibility
- ✅ Create page behavior unchanged
- ✅ Existing video upload flow preserved
- ✅ No breaking changes to existing functionality

### Recovery Mechanism
- ✅ Can fix existing orphaned videos
- ✅ Admin tools for video management
- ✅ Prevents duplicate associations

## Testing

### Manual Test Steps
1. Go to listing edit page (e.g., KOPSI5)
2. Upload a video in Product Videos section
3. Video should appear immediately in the section
4. Refresh page - video should still be there
5. Check public listing page - video should be visible

### API Test
```bash
# Find orphaned videos
GET /api/admin/associate-orphaned-videos?listingId=KOPSI5

# Associate orphaned video
POST /api/admin/associate-orphaned-videos
{
  "listingId": "KOPSI5",
  "videoId": "cmffrf12b0006l404an7jsvkh"
}
```

## Files Modified
- `app/components/VideoUpload.tsx` - Added listingId parameter and immediate association
- `app/api/upload/video/presigned-url/route.ts` - Fixed auth and added listing association
- `app/(dashboard)/list-item/[id]/edit/page.tsx` - Pass listingId to VideoUpload
- `app/(dashboard)/list-item/page.tsx` - Pass undefined listingId for create page
- `app/api/admin/associate-orphaned-videos/route.ts` - New recovery endpoint

## Future Enhancements
- Add UI in edit page to show and associate orphaned videos
- Automatic cleanup of old orphaned videos
- Bulk association tools for admins
- Video upload progress indicators with association status
